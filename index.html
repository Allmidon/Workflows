<!doctype html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>n8n × OpenAI — Frontend</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Estilos personalizados para el tema oscuro y formal -->
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      background-color: #000;
      /* Fondo negro sólido como la app anterior */
    }

    main {
      flex-shrink: 0;
      /* Evita que el contenido principal se encoja */
    }

    footer {
      margin-top: auto;
      /* Empuja el footer al final de la página */
    }

    /* Definición de la tarjeta de la app, similar a la anterior */
    .app-card {
      background-color: var(--bs-dark-subtle);
      border: 1px solid var(--bs-border-color);
      border-radius: 1rem;
      /* 16px */
      padding: 2.5rem;
      height: 100%;
      /* Hace que ambas columnas tengan la misma altura */
    }

    /* Estilo para las cajas de previsualización */
    pre[id="preview"],
    div[id="estado"],
    pre[id="respuesta"] {
      background-color: var(--bs-body-tertiary) !important;
      border: none !important;
      border-radius: 0.5rem;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }
  </style>
</head>

<body>

  <!-- 1. BARRA DE NAVEGACIÓN -->
  <nav class="navbar navbar-expand-lg bg-dark-subtle border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="#">n8n × OpenAI — Frontend</a>
      <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">Demo</span>
    </div>
  </nav>

  <!-- 2. CONTENIDO PRINCIPAL -->
  <main class="container my-5">
    <div class="row g-4">

      <!-- Columna del Formulario -->
      <div class="col-12 col-lg-6">
        <div class="app-card shadow-sm">
          <h1 class="h4 mb-3">Captura de datos</h1>
          <p class="text-body-secondary mb-4">Esta página obtiene tu IP pública y prepara el payload para un Webhook de
            n8n.</p>

          <form id="calc-form" class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="ipPublica" class="form-label">IP pública</label>
              <input type="text" id="ipPublica" class="form-control" readonly placeholder="Detectando IP..." />
              <div class="form-text">Se detecta automáticamente desde <code class="small">api.ipify.org</code>.</div>
            </div>

            <div class="row">
              <div class="col-sm-6 mb-3">
                <label for="operandoA" class="form-label">Operando A</label>
                <input type="number" step="any" id="operandoA" class="form-control" required placeholder="Ej. 12" />
                <div class="invalid-feedback">Ingresa un número válido.</div>
              </div>
              <div class="col-sm-6 mb-3">
                <label for="operandoB" class="form-label">Operando B</label>
                <input type="number" step="any" id="operandoB" class="form-control" required placeholder="Ej. 4" />
                <div class="invalid-feedback">Ingresa un número válido.</div>
              </div>
            </div>

            <div class="mb-3">
              <label for="userText" class="form-label">Texto para identificar la operación</label>
              <textarea id="userText" class="form-control" rows="3"
                placeholder="Ej.: 'Suma 12 y 4' o 'multiplica 12 por 4'"></textarea>
              <div class="form-text">Más adelante, OpenAI inferirá la operación a partir de este texto.</div>
            </div>

            <div class="d-grid gap-2">
              <button id="btnPreview" class="btn btn-outline-secondary" type="button">Previsualizar JSON</button>
              <button id="btnEnviar" class="btn btn-primary" type="submit">Enviar a n8n</button>
            </div>

            <div class="mt-3 small text-muted">
              ⚙️ La URL del Webhook ya está configurada en el código.
            </div>
          </form>
        </div>
      </div>

      <!-- Columna de Vista previa / Estado -->
      <div class="col-12 col-lg-6">
        <div class="app-card shadow-sm">
          <h2 class="h5 mb-3">Previsualización y estado</h2>

          <div class="mb-3">
            <label class="form-label">Payload (JSON)</label>
            <pre id="preview" class="border rounded p-3"
              style="min-height: 180px; white-space: pre-wrap;"></pre>
          </div>

          <div class="mb-3">
            <label class="form-label">Estado</label>
            <div id="estado" class="border rounded p-3">Listo.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Respuesta del servidor</label>
            <pre id="respuesta" class="border rounded p-3"
              style="min-height: 120px; white-space: pre-wrap;"></pre>
          </div>

          <div class="small text-muted">
            Timestamp: <span id="tsPreview">—</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 3. PIE DE PÁGINA -->
  <footer class="pb-5">
    <div class="container">
      <hr class="my-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div class="text-body-secondary">© 2025 • Demo Frontend n8n/OpenAI</div>
        <div class="text-body-secondary">Hecho con Bootstrap • Listo para GitHub Pages</div>
      </div>
    </div>
  </footer>

  <!-- App (Contenido de main.js) -->
  <script>
    // =========================
    // Configuración
    // =========================
    // URL del Webhook (tomada de tu archivo JS)
    const WEBHOOK_URL = "https://paoortiz0311.app.n8n.cloud/webhook-test/bc6b83e8-9c44-44a0-8e46-5bcda551daab";

    // =========================
    // Utilidades
    // =========================
    const $ = (sel) => document.querySelector(sel);

    function buildPayload() {
      const ip = $("#ipPublica").value || "";
      const a = $("#operandoA").value;
      const b = $("#operandoB").value;
      const userText = $("#userText").value || "";
      const ts = new Date().toISOString();

      return {
        source: "frontend-demo",
        ip_publica: ip,
        operando_a: a === "" ? null : Number(a),
        operando_b: b === "" ? null : Number(b),
        user_message: userText,
        timestamp: ts
      };
    }

    function showPreview() {
      const payload = buildPayload();
      $("#preview").textContent = JSON.stringify(payload, null, 2);
      $("#tsPreview").textContent = payload.timestamp;
    }

    async function detectIP() {
      try {
        const r = await fetch("https://api.ipify.org?format=json");
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        const j = await r.json();
        $("#ipPublica").value = j.ip || "";
      } catch (e) {
        $("#ipPublica").value = "Error al detectar IP";
        console.warn("No se pudo obtener IP pública:", e);
      }
    }

    // =========================
    /** Inicio */
    // =========================
    (async () => {
      // Espera a que el DOM esté listo
      await document.fonts.ready;

      await detectIP();
      showPreview();

      // Previsualizar
      $("#btnPreview").addEventListener("click", showPreview);

      // Enviar
      $("#calc-form").addEventListener("submit", async (ev) => {
        ev.preventDefault();

        // Validación de Bootstrap
        const form = ev.currentTarget;
        if (!form.checkValidity()) {
          ev.stopPropagation();
          form.classList.add("was-validated");
          return;
        }
        form.classList.add("was-validated");


        const estado = $("#estado");
        const respuesta = $("#respuesta");
        const btnEnviar = $("#btnEnviar");
        respuesta.textContent = "";

        const payload = buildPayload();
        showPreview();

        if (!WEBHOOK_URL) {
          estado.textContent = "No se envió: agrega tu WEBHOOK_URL para enviar a n8n.";
          return;
        }

        // --- Estado de Carga ---
        estado.textContent = "Enviando...";
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = `
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Enviando...
        `;

        try {
          const r = await fetch(WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          
          const text = await r.text();
          estado.textContent = `Respuesta recibida (HTTP ${r.status})`;
          
          // Intenta formatear la respuesta si es JSON
          try {
            const jsonRes = JSON.parse(text);
            respuesta.textContent = JSON.stringify(jsonRes, null, 2);
          } catch (jsonError) {
            // Si no es JSON, solo muestra el texto
            respuesta.textContent = text;
          }

        } catch (e) {
          estado.textContent = "Error al enviar. Revisa la consola (F12).";
          respuesta.textContent = String(e);
        } finally {
          // --- Restablecer Botón ---
          btnEnviar.disabled = false;
          btnEnviar.innerHTML = "Enviar a n8n";
        }
      });
    })();
  </script>

  <!-- Bootstrap JS (opcional pero recomendado para algunas funciones) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>
